

## issue 添加node之后发现cilium pod crash了 

```
level=info msg="  --tofqdns-pre-cache=''" subsys=daemon
level=info msg="  --tofqdns-proxy-port='0'" subsys=daemon
level=info msg="  --tofqdns-proxy-response-max-delay='100ms'" subsys=daemon
level=info msg="  --trace-payloadlen='128'" subsys=daemon
level=info msg="  --tunnel='vxlan'" subsys=daemon
level=info msg="  --version='false'" subsys=daemon
level=info msg="  --write-cni-conf-when-ready=''" subsys=daemon
level=info msg="     _ _ _" subsys=daemon
level=info msg=" ___|_| |_|_ _ _____" subsys=daemon
level=info msg="|  _| | | | | |     |" subsys=daemon
level=info msg="|___|_|_|_|___|_|_|_|" subsys=daemon
level=info msg="Cilium 1.9.90 3b56fc99a 2020-12-22T13:34:26+01:00 go version go1.15.6 linux/amd64" subsys=daemon
level=info msg="cilium-envoy  version: 6c980c60fb96e27faae370af792217316482c2ed/1.14.5/Modified/RELEASE/BoringSSL" subsys=daemon
level=info msg="clang (10.0.0) and kernel (5.10.2) versions: OK!" subsys=linux-datapath
level=info msg="linking environment: OK!" subsys=linux-datapath
level=info msg="BPF system config check: NOT OK." error="Kernel Config file not found" subsys=linux-datapath
level=warning msg="================================= WARNING ==========================================" subsys=bpf
level=warning msg="BPF filesystem is not mounted. This will lead to network disruption when Cilium pods" subsys=bpf
level=warning msg="are restarted. Ensure that the BPF filesystem is mounted in the host." subsys=bpf
level=warning msg="https://docs.cilium.io/en/stable/kubernetes/requirements/#mounted-bpf-filesystem" subsys=bpf
level=warning msg="====================================================================================" subsys=bpf
level=info msg="Mounting BPF filesystem at /sys/fs/bpf" subsys=bpf
level=info msg="Valid label prefix configuration:" subsys=labels-filter
level=info msg=" - :io.kubernetes.pod.namespace" subsys=labels-filter
level=info msg=" - :io.cilium.k8s.namespace.labels" subsys=labels-filter
level=info msg=" - :app.kubernetes.io" subsys=labels-filter
level=info msg=" - !:io.kubernetes" subsys=labels-filter
level=info msg=" - !:kubernetes.io" subsys=labels-filter
level=info msg=" - !:.*beta.kubernetes.io" subsys=labels-filter
level=info msg=" - !:k8s.io" subsys=labels-filter
level=info msg=" - !:pod-template-generation" subsys=labels-filter
level=info msg=" - !:pod-template-hash" subsys=labels-filter
level=info msg=" - !:controller-revision-hash" subsys=labels-filter
level=info msg=" - !:annotation.*" subsys=labels-filter
level=info msg=" - !:etcd_node" subsys=labels-filter
level=info msg="Auto-disabling \"enable-bpf-clock-probe\" feature since KERNEL_HZ cannot be determined" error="Cannot probe CONFIG_HZ" subsys=daemon
level=info msg="Using autogenerated IPv4 allocation range" subsys=node v4Prefix=10.229.0.0/16
level=info msg="Initializing daemon" subsys=daemon
level=info msg="Establishing connection to apiserver" host="https://10.96.0.1:443" subsys=k8s
```

// KernelConfigAvailable checks if the Kernel Config is available on the
// system or not.
func (p *ProbeManager) KernelConfigAvailable() bool {
    // Check Kernel Config is available or not.
    // We are replicating BPFTools logic here to check if kernel config is available
    // https://elixir.bootlin.com/linux/v5.7/source/tools/bpf/bpftool/feature.c#L390
    info := unix.Utsname{}
    err := unix.Uname(&info)
    if err != nil {
        return false
    }
    release := strings.TrimSpace(string(bytes.Trim(info.Release[:], "\x00")))

    // Any error checking these files will return Kernel config not found error
    if _, err := os.Stat(fmt.Sprintf("/boot/config-%s", release)); err != nil {
        if _, err = os.Stat("/proc/config.gz"); err != nil {
            return false
        }
    }

    return true
}



# k8s每个node上的IP分配

[root@node01 ~]# kubectl describe node node01  |grep -i io.cilium.network
Annotations:        io.cilium.network.ipv4-cilium-host: 10.0.0.223
                    io.cilium.network.ipv4-health-ip: 10.0.0.43
                    io.cilium.network.ipv4-pod-cidr: 10.0.0.0/24
[root@node01 ~]# kubectl describe node node02  |grep -i io.cilium.network
Annotations:        io.cilium.network.ipv4-cilium-host: 10.0.2.176
                    io.cilium.network.ipv4-health-ip: 10.0.2.254
                    io.cilium.network.ipv4-pod-cidr: 10.0.2.0/24
[root@node01 ~]# kubectl describe node node03  |grep -i io.cilium.network
Annotations:        io.cilium.network.ipv4-cilium-host: 10.0.1.203
                    io.cilium.network.ipv4-health-ip: 10.0.1.165
                    io.cilium.network.ipv4-pod-cidr: 10.0.1.0/24


Enable automatic node CIDR allocation (Recommended)

Kubernetes has the capability to automatically allocate and assign a per node IP allocation CIDR. Cilium automatically uses this feature if enabled. This is the easiest method to handle IP allocation in a Kubernetes cluster. To enable this feature, simply add the following flag when starting kube-controller-manager:

--allocate-node-cidrs
 Copy Line
This option is not required but highly recommended.



apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: "v1.19.2"
imageRepository: "pastack-registry.paic.com.cn"
controlPlaneEndpoint: "30.103.3.28:6443"
dns:
  type: CoreDNS
networking:
  dnsDomain: "cluster.local"
  podSubnet: "172.16.0.0/16"
  serviceSubnet: "10.96.0.0/12"
apiServer:
  extraArgs:
    authorization-mode: "Node,RBAC"
    enable-admission-plugins: "NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota"
  certSANs:
      - 30.103.3.28
      - node01


cilium竟然没有把podSubnet这个参数当回事儿。 

# 参数 dnsPolicy: ClusterFirstWithHostNet


